<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome to Prioritask</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
  </style>
</head>
<h1 id="welcomeMessage"></h1>
<h1 id="dayOfWeek"></h1>
<p id="currentDate"></p>

<input id="listInput" type="text" /></br>
<button id="newList">Create list</button>
<div class="lists"></div>
<button id="logout">Log Out</button>


<body>


  <script>
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    const username = localStorage.getItem('username');
    const lists = document.querySelector('.lists');
    const listInput = document.getElementById('listInput');
    const newList = document.getElementById('newList');
    const logout = document.getElementById('logout');

    if (!token) {
      // redirect to the login page if the token is not available
      window.location.href = 'loginUser.html';
    }

    //render welcome message
    let welcomeMessage = document.getElementById('welcomeMessage');
    welcomeMessage.innerHTML = `${username}'s PrioriTasks`;

    //get the current day
    document.addEventListener('DOMContentLoaded', function () {
      const dayOfWeekElement = document.getElementById('dayOfWeek');
      const currentDateElement = document.getElementById('currentDate');

      fetch('http://localhost:8080/calendar')
        .then(response => response.json())
        .then(data => {
          dayOfWeekElement.innerHTML = ` ${data.currentDayOfWeek}'s Todos`;
          currentDateElement.innerHTML = `Date: ${data.currentDate}`;
        })
        .catch(error => console.error('Error:', error));
    });

    fetchLists()

    //get list id when list name is clicked
    lists.addEventListener('click', (event) => {
      const clickedList = event.target.closest('.list');

      if (clickedList) {
        // Retrieve the list ID from the data attribute
        const listId = clickedList.getAttribute('id');
        localStorage.setItem("listId", listId);
      }
    });

    //deleting the token to log user out when button is clicked
    logout.addEventListener('click', (event) => {
      localStorage.removeItem("token");
      window.location.href = 'loginUser.html';
    });

    //rendering lists on page
    async function fetchLists() {

      const url = `http://localhost:8080/list/user/${userId}`;


      const config = {
        method: 'GET',

        headers: {
          'content-type': 'application/json',
        }
      };

      fetch(url, config).then((res) => {
        return res.json();
        //saving the response as loopList, variable used to loop through the lists
      }).then(loopList => {

        for (let i = 0; i < loopList.length; i++) {
          let thisList = loopList[i];

          //creating a new div for each list, with the list's id
          let div = document.createElement("div");
          div.innerHTML = `<h2 class="list" id="${thisList.id}">${thisList.listTitle}</h2>`;

          //creating a button for each list to delete it
          let deleteList = document.createElement("button");
          deleteList.id = parseInt(thisList.id);
          deleteList.className = "delete"
          deleteList.innerHTML = `<i class="fa fa-trash-o" style="font-size:24px"></i>`;

          //creating a button for each list to edit it
          let editList = document.createElement("button");
          editList.id = parseInt(thisList.id);
          editList.className = "edit"
          editList.innerHTML = `<i class="fa fa-pencil" style="font-size:24px"></i>`;

          //making sure the button is added to the div and then added to the lists div
          div.append(editList);
          div.append(deleteList);
          lists.appendChild(div);

          //when the delete button is clicked, it deletes list by id
          div.addEventListener('click', async (event) => {
            const listToDelete = event.target.closest('.delete');

            if (listToDelete) {
              const listId = listToDelete.getAttribute('id');

              const url = `http://localhost:8080/list/${listId}`

              const config = {
                method: 'DELETE',
                headers: {
                  'content-type': 'application/json'
                }
              };

              //reload page once the list is deleted
              await fetch(url, config).then((res) => {
                window.location.reload();

              })

            }

            
          });

           //when the edit button is clicked, it edits list by id
           div.addEventListener('click', async (evt) => {
            
            const listToEdit = evt.target.closest('.edit');

            if (listToEdit) {

              div.innerHTML = `<input id="input" type="text" /><button id="done" style='font-size:24px;'>&#10003;</button>`;

              let input = document.getElementById("input");
              let done = document.getElementById("done");

              done.addEventListener('click', async (evt) => {
                console.log(input.value)
                let updatedList = input.value;
                let listId = listToEdit.getAttribute('id');

                const url = `http://localhost:8080/list/${listId}`

              const config = {
                method: 'PUT',
                headers: {
                  'content-type': 'application/json'
                },
                body: JSON.stringify({listTitle: updatedList})
              };

              //reload page once the list is deleted
              await fetch(url, config).then((res) => {
                location.reload();
              })
              })
              


            }

            
          });

        }



      });


    }

    //creating a new list when button is clicked
    newList.addEventListener("click", () => {

      let listName = listInput.value;

      const url = `http://localhost:8080/list`


      const config = {
        method: 'POST',
        body: JSON.stringify({
          listTitle: listName,
          userId: userId
        }),
        headers: {
          'content-type': 'application/json'
        }

      };

      fetch(url, config).then((res) => {
        window.location.reload();

      })

    });





  </script>

  <style>
    * {
      background-color: rgb(156, 98, 98);
      border: none;
      justify-content: center;
      text-align: center;
    }




    #listInput {
      background: rgb(239, 237, 235);
      margin: 10px;
    }
  </style>

</body>

</html>