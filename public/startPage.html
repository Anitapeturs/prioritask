<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome to Prioritask</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap">
  <script src="https://kit.fontawesome.com/4be0ef7ca6.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="style.css">
</head>


<body>
  <i id="userSettings"class="fa-solid fa-user-pen"></i>
  <p id="currentDate"></p>
  <h1 id="dayOfWeek"></h1>

  <div class="lists"></div></br>
  
  <button id="logout" class="logout">Log Out</button>

  <script>

document.addEventListener('DOMContentLoaded', function () {
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    const username = localStorage.getItem('username');
    const lists = document.querySelector('.lists');
    const logout = document.getElementById('logout');
    const userSettings = document.getElementById('userSettings');

    const deleteConfig = {
        method: 'DELETE',
        headers: {
            'content-type': 'application/json',
            'Authorization': `Bearer ${token}`
        }
    };

    if (!token) {
        window.location.href = 'loginUser.html';
    }

    const dayOfWeekElement = document.getElementById('dayOfWeek');
    const currentDateElement = document.getElementById('currentDate');

    fetchLists();

    fetch('http://localhost:8080/calendar')
        .then(res => res.json())
        .then(data => {
            dayOfWeekElement.textContent = `${data.currentDayOfWeek}'s Todos`;
            currentDateElement.textContent = `Date: ${data.currentDate}`;
        })
        .catch(error => console.error('Error:', error));

    function fetchLists() {
        fetch(`http://localhost:8080/list/user/${userId}`)
            .then((res) => res.json())
            .then(loopList => {
                loopList.forEach(thisList => {
                    const listContainer = document.createElement("div");
                    listContainer.className = "list-container";

                    const theList = document.createElement("div");
                    theList.id = parseInt(thisList.id);
                    theList.className = "list";
                    theList.textContent = thisList.listTitle;
                    theList.className = "list-title";
                    theList.style.cursor = "pointer";

                    const newTask = document.createElement("input");
                    newTask.id = parseInt(thisList.id);
                    newTask.className = "newTask";
                    newTask.placeholder = "Add new task";

                    const listButtons = document.createElement('div');
                    listButtons.className = "listButtons";

                    const deleteList = document.createElement("div");
                    deleteList.id = parseInt(thisList.id);
                    deleteList.className = "deleteList";
                    deleteList.innerHTML = `<i class="fa fa-trash-o" aria-hidden="true" title="Delete List"></i>`;
                    deleteList.style.cursor = "pointer";

                    const editList = document.createElement("div");
                    editList.id = parseInt(thisList.id);
                    editList.className = "editList";
                    editList.innerHTML = `<i class="fa fa-pencil" aria-hidden="true" title="Edit List"></i>`;
                    editList.style.cursor = "pointer";

                    listButtons.appendChild(editList);
                    listButtons.appendChild(deleteList);
                    listContainer.append(listButtons);
                    listContainer.append(theList);
                    listContainer.append(newTask);

                    fetch(`http://localhost:8080/task/list/${thisList.id}`)
                        .then((res) => res.json())
                        .then(tasks => {
                            const taskContainer = document.createElement("div");
                            taskContainer.className = "task-container";

                            tasks.forEach(listTask => {
                                const theTask = document.createElement("div");
                                theTask.id = listTask.id;
                                theTask.className = "task";
                                theTask.textContent = listTask.task;
                                theTask.style.cursor = "pointer";

                                const deleteTask = document.createElement("button");
                                deleteTask.id = parseInt(listTask.id);
                                deleteTask.className = "deleteTask";
                                deleteTask.innerHTML = `<i class="fa fa-trash-o" aria-hidden="true" title="Delete Task"></i>`;
                                deleteTask.style.cursor = "pointer";

                                const checkbox = document.createElement("input");
                                checkbox.type = "checkbox";
                                checkbox.className = "checkbox";
                                checkbox.style.cursor = "pointer";
                                checkbox.checked = listTask.completed;

                                checkbox.addEventListener('change', async () => {
                                    const url = `http://localhost:8080/task/completed/${listTask.id}`;
                                    const config = {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({ completed: checkbox.checked })
                                    };

                                    try {
                                        const response = await fetch(url, config);
                                        if (!response.ok) {
                                            console.error('Failed to update task:', response.status);
                                        }
                                    } catch (error) {
                                        console.error('Error updating task:', error);
                                    }
                                });

                                taskContainer.appendChild(checkbox);
                                taskContainer.appendChild(deleteTask);
                                taskContainer.appendChild(theTask);

                                theTask.addEventListener('click', (evt) => {
                                    const taskToEdit = evt.target.closest('.task');
                                    if (taskToEdit) {
                                        theTask.innerHTML = `<input id="taskInput" type="text" value="${theTask.textContent}" /> <button id="doneTask"'>&#10003;</button>`;
                                        const input = document.getElementById("taskInput");
                                        const done = document.getElementById("doneTask");

                                        input.focus();

                                        done.addEventListener('click', async (evt) => {
                                            const updatedTask = input.value;
                                            const taskId = taskToEdit.getAttribute('id');
                                            const url = `http://localhost:8080/task/${taskId}`;

                                            const config = {
                                                method: 'PUT',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'Authorization': `Bearer ${token}`
                                                },
                                                body: JSON.stringify({ task: updatedTask })
                                            };

                                            try {
                                                const response = await fetch(url, config);
                                                if (response.ok) {
                                                    theTask.innerHTML = updatedTask;
                                                }
                                            } catch (error) {
                                                console.error('Could not delete task:', error);
                                            }
                                        });
                                    }
                                });

                                deleteTask.addEventListener('click', async () => {
                                    const taskId = deleteTask.id;
                                    const url = `http://localhost:8080/task/${taskId}`;

                                    try {
                                        const response = await fetch(url, deleteConfig);
                                        if (response.ok) {
                                            window.location.reload();
                                        }
                                    } catch (error) {
                                        console.error('Could not delete task:', error);
                                    }
                                });
                            });

                            listContainer.append(taskContainer);
                        })
                        .catch(error => console.error('Error fetching tasks:', error));

                    lists.append(listContainer);

                    deleteList.addEventListener('click', async () => {
                        const listId = deleteList.id;
                        const taskUrl = `http://localhost:8080/task/list/${listId}`;
                        const listUrl = `http://localhost:8080/list/${listId}`;

                        try {
                            const taskResponse = await fetch(taskUrl, deleteConfig);
                            if (taskResponse.ok) {
                                const listResponse = await fetch(listUrl, deleteConfig);
                                if (listResponse.ok) {
                                    window.location.reload();
                                }
                            } else {
                                console.error('Failed to delete list', taskResponse.status);
                            }
                        } catch (error) {
                            console.error('Could not delete list:', error);
                        }
                    });

                    editList.addEventListener('click', () => {
                        const updatedList = prompt('Enter new list name:');
                        const listId = editList.id;
                        const url = `http://localhost:8080/list/${listId}`;

                        const config = {
                            method: 'PUT',
                            headers: {
                                'content-type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ listTitle: updatedList })
                        };

                        fetch(url, config)
                            .then(response => {
                                if (response.ok) {
                                    theList.textContent = updatedList;
                                } else {
                                    console.error('Error updating list:', response.status);
                                }
                            })
                            .catch(error => console.error('Error updating list:', error));
                    });

                    newTask.addEventListener('keypress', async (evt) => {
                        if (evt.key === "Enter") {
                            const createdTask = newTask.value;
                            const listId = newTask.id;
                            const url = `http://localhost:8080/task`;

                            const config = {
                                method: 'POST',
                                headers: {
                                    'content-type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ task: createdTask, listId: listId, userId: userId })
                            };

                            fetch(url, config)
                                .then(response => {
                                    if (response.ok) {
                                        location.reload();
                                    } else {
                                        console.error('Error creating task:');
                                    }
                                })
                                .catch(error => console.error('Error creating task:', error));
                        }
                    });
                });
            });
    }

    userSettings.addEventListener('click', () => {
        window.location.href = 'userSettings.html';
    });

    lists.addEventListener('click', (evt) => {
        const clickedList = evt.target.closest('.list');
        if (clickedList) {
            const listId = clickedList.id;
            localStorage.setItem("listId", listId);
        }
    });

    logout.addEventListener('click', () => {
        localStorage.removeItem("token");
        window.location.href = 'loginUser.html';
    });
});
  </script>
</body>

</html>